<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Practice Arena</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">Practice Arena</div>
    <div class="nav">
      <a href="index.html">Dashboard</a>
      <a href="practice.html" class="active">Practice</a>
      <a href="gta.html">GTA</a>
      <a href="calc.html">Calculations</a>
      <a href="progress.html">Progress</a>
      <a href="tests.html">Tests</a>
    </div>
  </div>

  <main>
    <div class="card">
      <div class="h1">Practice Session</div>
      <div class="small">Start a timed question, submit result. Logs saved with unique id. Export per session (no duplicates).</div>

      <div style="margin-top:10px">
        <label class="small">Session Name</label>
        <input id="session" class="input" placeholder="">
        <div style="margin-top:8px" class="row">
          <label class="small">Subject</label>
          <select id="sub" class="input" style="width:180px"><option>Maths</option><option>Physics</option><option>Chemistry</option></select>
          <label class="small">Topic</label>
          <input id="topic" class="input" style="width:260px" placeholder="Topic (optional)">
          <label class="small">Difficulty</label>
          <select id="diff" class="input" style="width:180px"><option>Easy</option><option>Medium</option><option>Hard</option><option>Insane</option></select>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="start" class="btn">Start</button>
          <button id="stop" class="btn ghost">Stop</button>
          <button id="submit" class="btn">Submit</button>
          <button id="export" class="btn">Export Session</button>
          <button id="clear" class="btn ghost">Clear All</button>
        </div>

        <div style="margin-top:12px" class="h1" id="timer">00:00.0</div>
      </div>
    </div>

    <div class="card">
      <div class="h1">Recent Logs</div>
      <div id="list" class="list small"></div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="utils.js"></script>
<script>
let tmr=null, start=0, elapsed=0;
function fmt(ms){const s=Math.floor(ms/1000);const mm=String(Math.floor(s/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');const t=Math.floor(ms%1000/100);return `${mm}:${ss}.${t}`}

function init(){ if(!localStorage.getItem('su_default_session')) localStorage.setItem('su_default_session','Session_'+new Date().toISOString().slice(0,10)+'_#1'); document.getElementById('session').value = localStorage.getItem('su_default_session'); }
init();

document.getElementById('start').addEventListener('click', ()=>{
  if(tmr) return;
  start = Date.now()-elapsed;
  tmr = setInterval(()=>{ elapsed = Date.now()-start; document.getElementById('timer').textContent = fmt(elapsed); }, 100);
});
document.getElementById('stop').addEventListener('click', ()=>{ if(tmr) clearInterval(tmr); tmr=null; });

function calcPoints(time,diff){
  const base = diff==='Easy'?5:diff==='Medium'?10:diff==='Hard'?20:40;
  const mult = diff==='Easy'?1:diff==='Medium'?1.5:diff==='Hard'?2:3;
  const timePenalty = Math.min(30, Math.floor(time/3));
  return Math.max(0, Math.round(base*mult - timePenalty));
}

document.getElementById('submit').addEventListener('click', ()=>{
  if(tmr) clearInterval(tmr); tmr=null;
  const timeSec = Math.round((elapsed||0)/1000);
  const subject = document.getElementById('sub').value;
  const topic = document.getElementById('topic').value;
  const diff = document.getElementById('diff').value;
  const session = document.getElementById('session').value || localStorage.getItem('su_default_session');
  const points = calcPoints(timeSec,diff);
  const entry = { session, subject, topic, diff, time:timeSec, points, result:'pending', t: Date.now() };
  const ok = savePracticeEntry(entry);
  if(!ok){ alert('Duplicate prevented (try again)'); } else { addXP(points,'practice'); alert('Saved +'+points+' XP'); }
  elapsed=0; document.getElementById('timer').textContent='00:00.0'; render();
});

function render(){
  const root=document.getElementById('list'); root.innerHTML='';
  const arr=load(SU.KEYS.PRACTICE,[]).slice().reverse();
  if(!arr.length) root.innerHTML='<div class="small">No logs yet</div>';
  arr.forEach((a,i)=>{
    const d=document.createElement('div'); d.className='topic';
    d.innerHTML = `<div><strong>${a.subject}${a.topic? ' ‚Ä¢ '+a.topic : ''}</strong><div class='small'>${a.diff} ‚Ä¢ ${a.time}s ‚Ä¢ ${new Date(a.t).toLocaleString()}</div></div>
      <div><div class='small'>${a.result}</div>
      <div style='display:flex;gap:6px;margin-top:6px'>
        <button class='btn' data-i='${i}' data-act='correct'>‚úÖ</button>
        <button class='btn' data-i='${i}' data-act='incorrect'>‚ùå</button>
        <button class='btn' data-i='${i}' data-act='na'>‚ö™</button>
        <button class='btn' data-i='${i}' data-act='del'>üóëÔ∏è</button>
      </div></div>`;
    root.appendChild(d);
  });

  root.querySelectorAll('button[data-act]').forEach(btn=> btn.addEventListener('click', ()=>{
    const idx = Number(btn.getAttribute('data-i'));
    const act = btn.getAttribute('data-act');
    const arr = load(SU.KEYS.PRACTICE,[]);
    const entry = arr[arr.length-1-idx];
    if(!entry) return;
    if(act==='correct'){ entry.result='Correct'; entry.points = Math.max(1, entry.points + Math.round(entry.points*0.2)); save(SU.KEYS.PRACTICE,arr); addXP(Math.round(entry.points*0.2),'practice_correct'); }
    else if(act==='incorrect'){ entry.result='Incorrect'; entry.points=0; save(SU.KEYS.PRACTICE,arr); }
    else if(act==='na'){ entry.result='Not Attempted'; save(SU.KEYS.PRACTICE,arr); }
    else if(act==='del'){ if(confirm('Delete?')){ arr.splice(arr.length-1-idx,1); save(SU.KEYS.PRACTICE,arr); } }
    render();
  }));
}

document.getElementById('export').addEventListener('click', ()=>{
  const session = document.getElementById('session').value || localStorage.getItem('su_default_session');
  const all = load(SU.KEYS.PRACTICE,[]);
  const sel = all.filter(x => x.session === session);
  if(!sel.length){ alert('No logs'); return; }
  const seen = {}; const unique = [];
  sel.forEach(r => { if(!seen[r.t]){ seen[r.t] = true; unique.push(r); } });
  const ws = [['Date','Session','Subject','Topic','Difficulty','Time(s)','Result','Points']];
  unique.forEach(r => ws.push([ new Date(r.t).toLocaleString(), r.session, r.subject, r.topic||'', r.diff, r.time, r.result, r.points ]));
  const wb = XLSX.utils.book_new(); const ws1 = XLSX.utils.aoa_to_sheet(ws); XLSX.utils.book_append_sheet(wb, ws1, 'Practice');
  XLSX.writeFile(wb, 'Sunstrike_Practice_'+session+'.xlsx');
});

document.getElementById('clear').addEventListener('click', ()=>{
  if(!confirm('Clear ALL logs?')) return;
  save(SU.KEYS.PRACTICE,[]);
  render();
});

render();
</script>
</body>
</html>