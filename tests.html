<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tests — Sunstrike</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <div class="header"><div class="brand">Tests</div><div class="nav"><a href="index.html">Dashboard</a><a href="practice.html">Practice</a><a href="gta.html">GTA</a><a href="calc.html">Calculations</a><a href="progress.html">Progress</a><a href="tests.html" class="active">Tests</a></div></div>

  <main>
    <div class="card">
      <div class="h1">Add Test</div>
      <label class="small">Name</label><input id="name" class="input">
      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1"><label class="small">Maths (max 100)</label><input id="m" class="input"></div>
        <div style="flex:1"><label class="small">Physics</label><input id="p" class="input"></div>
        <div style="flex:1"><label class="small">Chemistry</label><input id="c" class="input"></div>
      </div>
      <label class="small">Percentile (optional)</label><input id="perc" class="input">
      <div style="margin-top:8px" class="row"><button id="add" class="btn">Add</button><button id="export" class="btn">Export</button><button id="clear" class="btn ghost">Clear</button></div>
    </div>

    <div class="card">
      <div class="h1">Saved Tests</div>
      <div id="list" class="list small"></div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="utils.js"></script>
<script>
function render(){
  const root=document.getElementById('list'); root.innerHTML='';
  const arr=load(SU.KEYS.TESTS,[]).slice().reverse();
  if(!arr.length){ root.innerHTML='<div class="small">No tests</div>'; return; }
  arr.forEach(t=>{
    const d=document.createElement('div'); d.className='topic';
    d.innerHTML = `<div><strong>${t.name}</strong><div class='small'>M:${t.m} P:${t.p} C:${t.c} • Total:${t.total} • Perc:${t.perc||'—'}</div></div><div style='display:flex;gap:6px'><button class='btn' data-d='${t.t}'>Delete</button></div>`;
    root.appendChild(d);
  });
  root.querySelectorAll('[data-d]').forEach(b=> b.addEventListener('click', ()=>{
    if(!confirm('Delete?')) return;
    const t=Number(b.getAttribute('data-d'));
    const arr=load(SU.KEYS.TESTS,[]).filter(x=> x.t!==t);
    save(SU.KEYS.TESTS,arr);
    render();
    localStorage.setItem('su_tests_updated', Date.now());
  }));
}

document.getElementById('add').addEventListener('click', ()=>{
  const name=document.getElementById('name').value||('Test '+(load(SU.KEYS.TESTS,[]).length+1));
  const m=parseFloat(document.getElementById('m').value)||0;
  const p=parseFloat(document.getElementById('p').value)||0;
  const c=parseFloat(document.getElementById('c').value)||0;
  const perc=parseFloat(document.getElementById('perc').value)||null;
  const total = m+p+c;
  const entry = { name, m, p, c, total, perc, t: Date.now() };
  const arr = load(SU.KEYS.TESTS,[]); arr.push(entry); save(SU.KEYS.TESTS,arr);
  const xp = Math.round((m/100)*60 + (p/100)*60 + (c/100)*60);
  addXP(xp,'test');
  alert('Saved +'+xp+' XP');
  document.getElementById('name').value=''; document.getElementById('m').value=''; document.getElementById('p').value=''; document.getElementById('c').value=''; document.getElementById('perc').value='';
  render(); localStorage.setItem('su_tests_updated', Date.now());
});

document.getElementById('export').addEventListener('click', ()=>{
  const arr=load(SU.KEYS.TESTS,[]);
  if(!arr.length){ alert('No tests'); return; }
  const ws=[['Name','Date','Maths','Physics','Chemistry','Total','Percentile']];
  arr.forEach(t=> ws.push([t.name, new Date(t.t).toLocaleDateString(), t.m, t.p, t.c, t.total, t.perc||'']));
  const wb=XLSX.utils.book_new(); const ws1=XLSX.utils.aoa_to_sheet(ws); XLSX.utils.book_append_sheet(wb, ws1, 'Tests'); XLSX.writeFile(wb, 'Sunstrike_Tests_'+new Date().toISOString().slice(0,10)+'.xlsx');
});

document.getElementById('clear').addEventListener('click', ()=>{
  if(!confirm('Clear all tests?')) return;
  save(SU.KEYS.TESTS,[]);
  render();
  localStorage.setItem('su_tests_updated', Date.now());
});

render();
</script>
</body>
</html>